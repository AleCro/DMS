import java.io.File;
import java.io.FileNotFoundException;
import java.util.Arrays;
import java.util.List;
import java.util.Scanner;
import java.util.ArrayList;

/**
 * Console helper for importing fish records from a structured text file
 * into the Florida Native Fish Database Management System (DMS).
 *
 * <p>Purpose:</p>
 * <p>
 * {@code AddFishFromFile} prompts the user for a file path, validates the
 * fileâ€™s basic structure, parses each line into a {@link Fish} object, and
 * delegates insertion to {@link FishManager}. It runs in both database and
 * local (in-memory) modes transparently through the shared manager.
 * </p>
 *
 * <p>Supported behavior:</p>
 * <ul>
 *     <li>Show example file format and rules on demand.</li>
 *     <li>Validate that each line contains the expected fields.</li>
 *     <li>Report per-line validation errors without stopping the import.</li>
 *     <li>Add valid fish entries and warn when tags already exist.</li>
 * </ul>
 */
public class AddFishFromFile {

    /** Scanner used for reading user input from the console. */
    private final Scanner scanner;

    /** Shared manager used to add or validate fish records. */
    private final FishManager fishManager;

    /**
     * Constructs a new {@code AddFishFromFile} helper bound to a {@link FishManager}.
     *
     * @param fishManager the manager responsible for adding and validating fish records
     */
    public AddFishFromFile(FishManager fishManager) {
        this.scanner = new Scanner(System.in);
        this.fishManager = fishManager;
    }

    /**
     * Main entry point for importing fish from a text file.
     *
     * <p>This method:</p>
     * <ol>
     *     <li>Shows a short header for the import feature.</li>
     *     <li>Prompts the user for a file path, {@code ~} to go back, or {@code ?} for format help.</li>
     *     <li>Validates that the file exists before attempting to read it.</li>
     *     <li>Delegates parsing and validation to {@link #processFile(File)}.</li>
     *     <li>Repeats until the user chooses to return to the main menu.</li>
     * </ol>
     */
    public void addFishFromFile() {
        System.out.println("\nAdd Fish From File");
        while (true) {
            System.out.print("Enter file path or name (press ~ to go back, ? to see expected format): ");
            String input = scanner.nextLine();

            // Return to menu
            if (input.equals("~")) {
                System.out.println("Returning to main menu...");
                return;
            }

            // Show example format
            if (input.equals("?")) {
                showFileFormat();
                continue;
            }

            // Validate file existence
            File file = new File(input);
            if (!file.exists()) {
                System.out.println("File not found, please try again.");
                continue;
            }

            // Process the file and handle potential format or runtime issues
            try {
                processFile(file);
            } catch (InvalidFileFormatException e) {
                System.out.println("File error: " + e.getMessage());
                System.out.println("Please fix the file and try again.");
            } catch (Exception e) {
                System.out.println("Unexpected error: " + e.getMessage());
                System.out.println("Please try again.");
            }

            System.out.println("\nYou can add another file, or press ~ to go back to the main menu.");
        }
    }

    /**
     * Displays a formatted example and validation rules
     * to help the user understand how the input text file should look.
     *
     * <p>This helper is triggered when the user enters {@code ?}
     * at the file-path prompt.</p>
     */
    private void showFileFormat() {
        System.out.println("\nExpected file format per line:");
        System.out.println("Common Name - Scientific Name - Average Size with unit - Diet - Habitats (comma-separated) - Conservation Status - Tag");
        System.out.println("Example:");
        System.out.println("Bass - Micropterus - 12 in - 3 crabs, algae - Swamp, Pond, River - Least Concern - 000-00-0001\n");
        System.out.println("Rules:");
        System.out.println("- Common Name: letters only");
        System.out.println("- Scientific Name: letters only");
        System.out.println("- Average Size: numeric value followed by a unit (mm, cm, m, in, ft, yd)");
        System.out.println("- Diet: comma-separated items; optional number and name, e.g., 'algae' or '3 crabs, 2 shrimp'");
        System.out.println("- Habitats: comma-separated list of names");
        System.out.println("- Conservation Status: one of 'Least Concern', 'Near Threatened', 'Vulnerable', 'Endangered', 'Critically Endangered'");
        System.out.println("- Tag: must follow the format 000-00-0000\n");
    }

    /**
     * Processes a provided file, validating and importing each fish entry.
     *
     * <p>For each non-empty line, this method:</p>
     * <ol>
     *     <li>Splits the line into seven expected fields using {@code " - "} delimiters.</li>
     *     <li>Validates basic constraints (names, size, units, diet format, tag pattern, habitats, status).</li>
     *     <li>Logs all detected issues per line without stopping the import.</li>
     *     <li>Constructs a {@link Fish} for valid lines and passes it to {@link FishManager#addFish(Fish)}.</li>
     *     <li>Warns, but does not block, if a tag already exists.</li>
     * </ol>
     *
     * @param file the text file to process
     * @throws InvalidFileFormatException if the file cannot be found or opened for reading
     */
    private void processFile(File file) throws InvalidFileFormatException {
        int addedCount = 0;
        try (Scanner fileScanner = new Scanner(file)) {
            int lineNumber = 0;

            while (fileScanner.hasNextLine()) {
                lineNumber++;
                String line = fileScanner.nextLine().trim();
                if (line.isEmpty()) {
                    continue;
                }

                // Expect exactly 7 sections separated by dashes
                String[] parts = line.split("\\s*-\\s*", 7);
                if (parts.length != 7) {
                    System.out.println("Line " + lineNumber + " invalid: does not have 7 fields -> " + line);
                    continue;
                }

                // Extract and clean values
                String commonName = parts[0].trim();
                String scientificName = parts[1].trim();
                String averageSizeInput = parts[2].trim().toLowerCase();
                String diet = parts[3].trim();
                String habitatsInput = parts[4].trim();
                String status = parts[5].trim();
                String tag = parts[6].trim();

                List<String> errors = new ArrayList<>();

                // Validate text fields
                if (!commonName.matches("[a-zA-Z ]+")) {
                    errors.add("Invalid common name: '" + commonName + "'");
                }
                if (!scientificName.matches("[a-zA-Z ]+")) {
                    errors.add("Invalid scientific name: '" + scientificName + "'");
                }

                // Validate average size and unit
                double averageSize = -1;
                String[] sizeParts = averageSizeInput.split("\\s+");
                if (sizeParts.length != 2) {
                    errors.add("Average size must include number and unit, e.g., '12 in'");
                } else {
                    String numericPart = sizeParts[0].replaceAll("[^\\d.]", "");
                    String unit = sizeParts[1];
                    List<String> allowedUnits = Arrays.asList("mm", "cm", "m", "in", "ft", "yd");
                    if (!allowedUnits.contains(unit)) {
                        errors.add("Invalid unit: '" + unit + "' (allowed: mm, cm, m, in, ft, yd)");
                    }
                    try {
                        averageSize = Double.parseDouble(numericPart);
                        if (averageSize <= 0) {
                            errors.add("Average size must be greater than 0");
                        }
                    } catch (NumberFormatException e) {
                        errors.add("Invalid numeric size: '" + numericPart + "'");
                    }
                }

                // Validate diet format
                String[] dietItems = diet.split("\\s*,\\s*");
                for (String item : dietItems) {
                    if (!item.matches("(\\d+\\s)?[a-zA-Z ]+")) {
                        errors.add("Invalid diet item: '" + item + "' (e.g., 'algae' or '3 crabs, 2 shrimp')");
                    }
                }
                diet = String.join(", ", dietItems);

                // Validate tag format
                if (!tag.matches("\\d{3}-\\d{2}-\\d{4}")) {
                    errors.add("Invalid tag: '" + tag + "' (format: 000-00-0000)");
                }

                // Parse habitats
                List<String> habitats = Arrays.asList(habitatsInput.split("\\s*,\\s*"));
                if (habitats.isEmpty()) {
                    errors.add("Habitats cannot be empty");
                }

                // Validate conservation status
                List<String> allowedStatus = Arrays.asList(
                        "Least Concern",
                        "Near Threatened",
                        "Vulnerable",
                        "Endangered",
                        "Critically Endangered"
                );
                if (!allowedStatus.contains(status)) {
                    errors.add("Invalid conservation status: '" + status + "'");
                }

                // Warn if tag already exists
                boolean duplicate = fishManager.getFishList().stream()
                        .anyMatch(f -> f.getTag().equals(tag));
                if (duplicate) {
                    System.out.println("Warning: a fish with tag " + tag + " already exists. Adding anyway.");
                }

                // Print validation errors and skip invalid lines
                if (!errors.isEmpty()) {
                    System.out.println("Line " + lineNumber + " has errors:");
                    for (String err : errors) {
                        System.out.println(" - " + err);
                    }
                    continue;
                }

                // Create and add valid fish
                Fish fish = new Fish(commonName, scientificName, averageSize, diet, habitats, status, tag);
                fishManager.addFish(fish);
                System.out.println("Fish added successfully: " + commonName + " (" + tag + ")");
                addedCount++;
            }

            System.out.println(addedCount + " fish added from file: " + file.getName());
        } catch (FileNotFoundException e) {
            throw new InvalidFileFormatException("File not found when reading.");
        }
    }

    /**
     * Custom checked exception used to signal formatting or read problems
     * encountered while importing a fish data file.
     */
    private static class InvalidFileFormatException extends Exception {

        /**
         * Constructs a new {@code InvalidFileFormatException} with the specified message.
         *
         * @param message human-readable description of the formatting or read error
         */
        public InvalidFileFormatException(String message) {
            super(message);
        }
    }
}
