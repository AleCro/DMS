import java.util.List;
import java.util.Scanner;

/**
 * Console user interface for the Florida Native Fish
 * Database Management System (DMS).
 *
 * <p>Purpose:</p>
 * <p>
 * {@code UI} is the top-level console controller responsible for
 * presenting menus, reading user input, and delegating actions
 * to feature-specific classes such as {@link AddFish},
 * {@link AddFishFromFile}, and {@link FishManagerUI}.
 * It transparently supports both database-connected and local
 * (mock) modes through the shared {@link FishDAO} and {@link FishManager}.
 * </p>
 *
 * <p>Primary responsibilities:</p>
 * <ul>
 *     <li>Display the main menu and route user choices to the correct feature.</li>
 *     <li>Initialize helper components used for adding, importing, and managing fish.</li>
 *     <li>Keep the in-memory fish list in sync when running in database mode.</li>
 *     <li>Provide a fun-facts submenu backed by {@link RandomFunFact} and analytics from {@link FishManager}.</li>
 * </ul>
 *
 * <p>Relationship to other classes:</p>
 * <ul>
 *     <li>Uses {@link FishDAO} to determine if the application is running in database mode.</li>
 *     <li>Uses {@link FishManager} for calculations and aggregate operations.</li>
 *     <li>Delegates CRUD-style console interactions to {@link FishManagerUI}.</li>
 *     <li>Uses {@link AddFish} and {@link AddFishFromFile} to add new records.</li>
 * </ul>
 */
public class UI {

    /** Scanner used to read user input from the console. */
    private final Scanner scanner;

    /** Helper class for adding a single fish via console. */
    private final AddFish addFish;

    /** Helper class for importing fish records from a file. */
    private final AddFishFromFile addFishFromFile;

    /** Manager providing business logic and analytics for fish data. */
    private final FishManager fishManager;

    /** Console-based manager for listing, searching, updating, and removing fish. */
    private final FishManagerUI fishManagerUI;

    /** Data access object used to determine mode and access persistence. */
    private final FishDAO fishDAO;

    /** Shared list of fish records, synchronized with DAO in database mode. */
    private final List<Fish> fishList;

    /**
     * Constructs a new {@code UI} controller with the given DAO and manager.
     *
     * <p>This constructor also initializes the helper components used for
     * adding fish, importing from files, and managing fish records. It
     * reports whether the system is running in database-connected or local
     * (in-memory) mode, and prepares {@link RandomFunFact} for use.</p>
     *
     * @param dao         the {@link FishDAO} used for persistence and mode detection
     * @param fishManager the {@link FishManager} that exposes fish operations and analytics
     */
    public UI(FishDAO dao, FishManager fishManager) {
        this.scanner = new Scanner(System.in);
        this.fishDAO = dao;
        this.fishManager = fishManager;
        this.fishList = fishManager.getFishList();

        if (fishDAO.isUsingDatabase()) {
            System.out.println("‚úî Loaded " + fishList.size() + " fish from database.");
        } else {
            System.out.println("üêü Running in local in-memory mode.üêü\n");
        }

        this.addFish = new AddFish(fishManager);
        this.addFishFromFile = new AddFishFromFile(fishManager);
        this.fishManagerUI = new FishManagerUI(fishManager, scanner);

        // Initialize random fun facts with shared FishManager data
        RandomFunFact.initialize(fishManager);
    }

    /**
     * Displays the main menu and routes user input to the appropriate actions.
     *
     * <p>Available options include:</p>
     * <ul>
     *     <li>Add a single fish record.</li>
     *     <li>Add fish records from a structured file.</li>
     *     <li>Open the manage-fish console (list, search, update, remove, duplicate check).</li>
     *     <li>Open the fun-facts submenu with analytics and random facts.</li>
     *     <li>Exit the application.</li>
     * </ul>
     *
     * <p>This method runs in a loop until the user chooses to exit.</p>
     */
    public void showMainMenu() {
        while (true) {
            System.out.println("Welcome to the Florida Native Fish DMS!");
            System.out.println("Each fish has a unique numeric Fish Tag. Use this Tag to manage records.\n");
            System.out.println("Mode: " + (fishDAO.isUsingDatabase() ? "Database Connected " : "Local Mock "));

            System.out.println("\n--- Main Menu ---");
            System.out.println("1. Add Fish");
            System.out.println("2. Add Fish from File");
            System.out.println("3. Manage Fish Added");
            System.out.println("4. Random Fish Fun Facts");
            System.out.println("5. Exit");
            System.out.print("Enter choice (1‚Äì5): ");

            String choice = scanner.nextLine().trim();

            switch (choice) {
                case "1" -> {
                    addFish.addFish();
                    if (fishDAO.isUsingDatabase()) {
                        // Synchronize the in-memory list with the latest database state
                        fishList.clear();
                        fishList.addAll(fishDAO.getAllFish());
                        System.out.println("‚úî Database updated successfully!");
                    }
                }
                case "2" -> addFishFromFile.addFishFromFile();
                case "3" -> fishManagerUI.showManageMenu();
                case "4" -> showRandomFunFacts();
                case "5" -> {
                    System.out.println("\nExiting system...");
                    return;
                }
                default -> System.out.println("Invalid choice. Please select 1‚Äì5.");
            }
        }
    }

    /**
     * Displays the Random Fish Fun Facts submenu.
     *
     * <p>Within this submenu, the user can:</p>
     * <ul>
     *     <li>Show a randomly selected fish-related fun fact.</li>
     *     <li>View the average number of habitats per fish.</li>
     *     <li>See the fish with the highest calculated ecological diversity.</li>
     * </ul>
     *
     * <p>The method returns when the user chooses to go back to the main menu.</p>
     */
    private void showRandomFunFacts() {
        while (true) {
            System.out.println("\n--- Random Fish Fun Facts ---");
            System.out.println("1. Show a random fish fun fact");
            System.out.println("2. Show average habitats per fish");
            System.out.println("3. Show the most ecologically diverse fish");
            System.out.println("~. Go back");
            System.out.print("Enter choice: ");

            String choice = scanner.nextLine().trim();

            switch (choice) {
                case "1" -> System.out.println("\n[Fun Fact] " + RandomFunFact.getRandomFact());
                case "2" -> System.out.printf(
                        "\nAverage Habitats per Fish: %.2f%n",
                        fishManager.calculateAverageHabitatsPerFish()
                );
                case "3" -> System.out.println(
                        "\nMost Ecologically Diverse Fish:\n" + fishManager.getTopDiversityFish()
                );
                case "~" -> { return; }
                default -> System.out.println("Invalid choice. Please select 1‚Äì3 or ~ to go back.");
            }
        }
    }
}
