/**
 * UI.java
 * Handles all user interactions for the Florida Native Fish Database Management System (DMS).
 * Supports both database-connected and local (mock) modes automatically.
 */

import java.util.List;
import java.util.Scanner;

public class UI {
    private final Scanner scanner;
    private final AddFish addFish;
    private final AddFishFromFile addFishFromFile;
    private final FishManager fishManager;
    private final FishManagerUI fishManagerUI;
    private final FishDAO fishDAO;
    private final List<Fish> fishList;

    /**
     * Constructor: Initializes UI with fish list and sets up dependencies.
     */
    public UI(FishDAO dao, FishManager fishManager) {
        this.scanner = new Scanner(System.in);
        this.fishDAO = dao;
        this.fishManager = fishManager;  // âœ… direct link
        this.fishList = fishManager.getFishList();

        if (fishDAO.isUsingDatabase()) {
            System.out.println("âœ” Loaded " + fishList.size() + " fish from database.");
        } else {
            System.out.println("ðŸŸ Running in local in-memory mode.ðŸŸ\n");
        }

        this.addFish = new AddFish(fishManager);
        this.addFishFromFile = new AddFishFromFile(fishManager);
        this.fishManagerUI = new FishManagerUI(fishManager, scanner);
        RandomFunFact.initialize(fishManager);
    }

    /**
     * Displays the main menu and routes user input.
     */
    public void showMainMenu() {
        while (true) {
            System.out.println("Welcome to the Florida Native Fish DMS!");
            System.out.println("Each fish has a unique numeric Fish Tag. Use this Tag to manage records.\n");
            System.out.println("Mode: " + (fishDAO.isUsingDatabase() ? "Database Connected " : "Local Mock "));

            System.out.println("\n--- Main Menu ---");
            System.out.println("1. Add Fish");
            System.out.println("2. Add Fish from File");
            System.out.println("3. Manage Fish Added");
            System.out.println("4. Random Fish Fun Facts");
            System.out.println("5. Exit");
            System.out.print("Enter choice (1â€“5): ");

            String choice = scanner.nextLine().trim();

            switch (choice) {
                case "1" -> {
                    addFish.addFish();
                    if (fishDAO.isUsingDatabase()) {
                        // Sync DB + memory after adding
                        fishList.clear();
                        fishList.addAll(fishDAO.getAllFish());
                        System.out.println("âœ” Database updated successfully!");
                    }
                }
                case "2" -> addFishFromFile.addFishFromFile();
                case "3" -> fishManagerUI.showManageMenu();
                case "4" -> showRandomFunFacts();
                case "5" -> {
                    System.out.println("\nExiting system...");
                    return;
                }
                default -> System.out.println("Invalid choice. Please select 1â€“5.");
            }
        }
    }

    /**
     * Fun Facts Submenu
     */
    private void showRandomFunFacts() {
        while (true) {
            System.out.println("\n--- Random Fish Fun Facts ---");
            System.out.println("1. Show a random fish fun fact");
            System.out.println("2. Show average habitats per fish");
            System.out.println("3. Show the most ecologically diverse fish");
            System.out.println("~. Go back");
            System.out.print("Enter choice: ");

            String choice = scanner.nextLine().trim();

            switch (choice) {
                case "1" -> System.out.println("\n[Fun Fact] " + RandomFunFact.getRandomFact());
                case "2" -> System.out.printf("\nAverage Habitats per Fish: %.2f%n", fishManager.calculateAverageHabitatsPerFish());
                case "3" -> System.out.println("\nMost Ecologically Diverse Fish:\n" + fishManager.getTopDiversityFish());
                case "~" -> { return; }
                default -> System.out.println("Invalid choice. Please select 1â€“3 or ~ to go back.");
            }
        }
    }
}
