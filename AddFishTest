import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import java.util.*;
import static org.junit.jupiter.api.Assertions.*;

/**
 * AddFishTest.java (Phase 4 - Final)
 *
 * Unit tests for the AddFish class.
 *
 * Validates:
 * - Fish records are added successfully through FishManager.
 * - Duplicate tags do not crash the system.
 * - Measurement units persist correctly.
 * - DAO/Manager integration behaves consistently in mock mode.
 * - Auto-correction of invalid average size is handled.
 */
public class AddFishTest {

    private FishDAO dao;
    private FishManager manager;
    private AddFish addFish;

    @BeforeEach
    void setup() {
        dao = new FishDAO();
        dao.connect(""); // mock (in-memory) mode
        dao.clearAll();
        manager = new FishManager(dao);
        addFish = new AddFish(manager);
    }

    /**
     * Helper to create a Fish instance.
     */
    private Fish makeFish(String name, String sci, double size, String diet,
                          List<String> habitats, String status, String tag) {
        Fish f = new Fish(name, sci, size, diet, habitats, status, tag);
        f.setMeasurementUnit("in");
        return f;
    }

    // ---- Add Fish Success ----
    @Test
    void testAddFishThroughManagerSuccess() {
        Fish f = makeFish("Bass", "Micropterus", 12.0,
                "insects, algae", List.of("River", "Lake"),
                "Vulnerable", "001-00-0001");

        boolean added = manager.addFish(f);
        assertTrue(added, "Fish should be added successfully via FishManager");

        List<Fish> list = manager.getFishList();
        assertEquals(1, list.size(), "Exactly one fish should exist after add");
        assertEquals("Bass", list.get(0).getCommonName());
    }

    // ---- Duplicate Tag Handling ----
    @Test
    void testDuplicateTagAllowedInMockMode() {
        manager.addFish(makeFish("Snook", "Centropomus", 15,
                "shrimp", List.of("Reef"), "Least Concern", "123-45-6789"));
        manager.addFish(makeFish("Bluegill", "Lepomis", 10,
                "worms", List.of("Lake"), "Least Concern", "123-45-6789"));

        List<Fish> all = manager.getFishList();
        assertEquals(2, all.size(), "Both fish should exist even with duplicate tags in mock mode");
        assertTrue(all.stream().anyMatch(f -> f.getCommonName().equals("Bluegill")),
                "Bluegill should appear in list");
    }

    // ---- Invalid Data Auto-Correction ----
    @Test
    void testInvalidFishAutoCorrectedThenValidAdded() {
        // Invalid size (0) auto-corrected to 1.0
        Fish invalid = makeFish("Bass", "Micropterus", 0,
                "algae", List.of("Lake"), "Least Concern", "001-00-0001");
        boolean addedInvalid = manager.addFish(invalid);
        assertTrue(addedInvalid, "Fish with 0 size should auto-correct to 1.0 and still be accepted");

        // Valid entry
        Fish valid = makeFish("Bass", "Micropterus", 12,
                "algae", List.of("Lake"), "Least Concern", "001-00-0002");
        boolean addedValid = manager.addFish(valid);
        assertTrue(addedValid, "Valid fish should also be accepted");

        List<Fish> list = manager.getFishList();
        assertEquals(2, list.size(), "Both corrected fish should exist");
        assertTrue(list.stream().anyMatch(f -> f.getAverageSize() == 1.0),
                "Invalid fish should have been corrected to 1.0 in size");
    }

    // ---- Cancel Operation (Simulated) ----
    @Test
    void testCancelDoesNothing() {
        int before = manager.getFishList().size();
        // Simulate user cancel by not calling addFish()
        int after = manager.getFishList().size();
        assertEquals(before, after, "No fish should be added when canceled");
    }

    // ---- Measurement Unit Validation ----
    @Test
    void testMeasurementUnitPersistence() {
        Fish f = makeFish("Goby", "Gobiidae", 3.5,
                "plankton", List.of("Reef"), "Least Concern", "007-00-0007");
        f.setMeasurementUnit("cm");
        manager.addFish(f);

        Fish stored = manager.getFishList().get(0);
        assertEquals("cm", stored.getMeasurementUnit(),
                "Measurement unit should persist correctly");
    }

    // ---- DAO / Manager Integration (Mock Mode) ----
    @Test
    void testIntegrationWithManagerInsteadOfDAO() {
        Fish f = makeFish("Tarpon", "Megalops", 25,
                "crustaceans", List.of("Reef"), "Least Concern", "009-00-0009");
        manager.addFish(f);

        // In mock mode, DAO doesnâ€™t persist; retrieve through manager
        Fish found = manager.findFishByTag("009-00-0009");
        assertNotNull(found, "Fish should be retrievable through FishManager in mock mode");
        assertEquals("Tarpon", found.getCommonName());
    }
}
