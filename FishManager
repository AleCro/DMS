import java.util.*;

/**
 * FishManager.java
 * Manages the operations related to fish records in the Florida Native Fish Database.
 * Provides both interactive (CLI) and testable methods for performing CRUD operations
 * such as adding, reading, updating, and removing fish. Also includes analytical methods.
 */
public class FishManager{
    private List<Fish> fishList;
    private Scanner scanner;

    public FishManager(List<Fish> fishList){
        this.fishList=fishList;
        this.scanner=new Scanner(System.in);
    }

    public List<Fish> getFishList(){return fishList;}

    public double calculateAverageHabitatsPerFish(){
        if(fishList.isEmpty())return 0.0;
        int totalHabitats=0;
        for(Fish fish:fishList)totalHabitats+=fish.getHabitats().size();
        return(double)totalHabitats/fishList.size();
    }

    public double calculateAverageSize(){
        if(fishList.isEmpty())return 0.0;
        double totalSize=0;
        for(Fish fish:fishList)totalSize+=fish.getAverageSize();
        return totalSize/fishList.size();
    }

    public String getTopDiversityFish(){
        if(fishList.isEmpty())return "No fish data available.";
        Fish topFish=null;
        int highestScore=0;
        for(Fish fish:fishList){
            int score=fish.getHabitats().size()*fish.getDiet().split("\\s+").length;
            if(score>highestScore){
                highestScore=score;
                topFish=fish;
            }
        }
        return topFish!=null?topFish.getCommonName()+" (score: "+highestScore+")":"No fish data available.";
    }

    public boolean addFish(Fish fish){
        if(fish==null)return false;
        return fishList.add(fish);
    }

    public Fish findFishByTag(String tag){
        for(Fish f:fishList){
            if(f.getTag().equals(tag))return f;
        }
        return null;
    }

    public boolean updateFishByTag(String tag,String newCommonName,String newScientificName,
                                   Double newAverageSize,String newDiet,List<String> newHabitats,
                                   String newStatus,String newTag){
        for(Fish f:fishList){
            if(f.getTag().equals(tag)){
                if(newCommonName!=null&&newCommonName.matches("[a-zA-Z ]+"))f.setCommonName(newCommonName);
                if(newScientificName!=null&&newScientificName.matches("[a-zA-Z ]+"))f.setScientificName(newScientificName);
                if(newAverageSize!=null&&newAverageSize>0)f.setAverageSize(newAverageSize);
                if(newDiet!=null&&!newDiet.isEmpty())f.setDiet(newDiet);
                if(newHabitats!=null&&!newHabitats.isEmpty())f.setHabitats(newHabitats);
                if(newStatus!=null&&!newStatus.isEmpty())f.setConservationStatus(newStatus);
                if(newTag!=null&&newTag.matches("\\d{3}-\\d{2}-\\d{4}"))f.setTag(newTag);
                return true;
            }
        }
        return false;
    }

    public boolean removeFishByTag(String tag){
        return fishList.removeIf(f->f.getTag().equals(tag));
    }

    public Map<String,Integer> getDuplicateTags(){
        Map<String,Integer> tagCounts=new HashMap<>();
        for(Fish f:fishList){
            tagCounts.put(f.getTag(),tagCounts.getOrDefault(f.getTag(),0)+1);
        }
        tagCounts.entrySet().removeIf(entry->entry.getValue()<2);
        return tagCounts;
    }

    public void showManageMenu(){
        while(true){
            System.out.println("\n--- Manage Fish Menu ---");
            System.out.println("1. List all fish");
            System.out.println("2. Search fish by tag number");
            System.out.println("3. Update fish by tag number");
            System.out.println("4. Remove fish by tag number");
            System.out.println("5. Check for duplicate tags");
            System.out.println("~. Go back");
            System.out.print("Enter choice: ");
            String choice=scanner.nextLine();
            if(choice.equals("~"))return;
            switch(choice){
                case "1"->listAllFish();
                case "2"->searchFishByTag();
                case "3"->interactiveUpdateFish();
                case "4"->interactiveRemoveFish();
                case "5"->checkDuplicateTagsCLI();
                default->System.out.println("Invalid choice. Please select 1â€“5 or ~ to go back.");
            }
        }
    }

    private void listAllFish(){
        if(fishList.isEmpty()){
            System.out.println("No fish added yet.");
            return;
        }
        System.out.println("\n--- All Fish ---");
        for(Fish fish:fishList){
            System.out.println(fish);
            System.out.println("---------------------");
        }
    }

    private void searchFishByTag(){
        System.out.print("\nEnter tag to search (~ to go back): ");
        String tag=scanner.nextLine();
        if(tag.equals("~"))return;
        Fish f=findFishByTag(tag);
        if(f==null)System.out.println("Fish not found.");
        else System.out.println("Found:\n"+f);
    }

    private void interactiveUpdateFish(){
        System.out.print("Enter tag to update (~ to cancel): ");
        String tag=scanner.nextLine();
        if(tag.equals("~"))return;
        Fish f=findFishByTag(tag);
        if(f==null){
            System.out.println("No fish found with that tag.");
            return;
        }
        System.out.println("Updating fish: "+f.getCommonName());
        System.out.print("Enter new common name (blank to skip): ");
        String newCommon=scanner.nextLine().trim();
        System.out.print("Enter new diet (blank to skip): ");
        String newDiet=scanner.nextLine().trim();
        updateFishByTag(tag,newCommon.isEmpty()?null:newCommon,null,null,
                newDiet.isEmpty()?null:newDiet,null,null,null);
        System.out.println("Fish updated successfully.");
    }

    private void interactiveRemoveFish(){
        System.out.print("Enter tag to remove (~ to cancel): ");
        String tag=scanner.nextLine();
        if(tag.equals("~"))return;
        boolean removed=removeFishByTag(tag);
        System.out.println(removed?"Fish removed successfully.":"Fish not found.");
    }

    private void checkDuplicateTagsCLI(){
        Map<String,Integer> dupes=getDuplicateTags();
        System.out.println("\n--- Duplicate Tag Report ---");
        if(dupes.isEmpty())System.out.println("No duplicate tags found.");
        else dupes.forEach((tag,count)->System.out.println("Tag "+tag+" occurs "+count+" times."));
    }
}
