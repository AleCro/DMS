/**
 * FishDAOTest.java (Phase 4 â€“ Final)
 *
 * Verifies CRUD and analytical operations across FishDAO and FishManager.
 * Uses mock (in-memory) behavior so no SQLite file is required.
 * Confirms that methods handle duplicates, missing data, and edge cases safely.
 */

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.io.File;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

public class FishDAOTest {

    private FishDAO fishDAO;

    @BeforeEach
    void setUp() {
        // Always run in mock mode for testing (no DB file needed)
        fishDAO = new FishDAO();
        fishDAO.connect("");  // Forces local mode
        fishDAO.clearAll();
    }

    // ---- Verify that a file can be opened (simulated) ----
    @Test
    void testFileCanBeOpened() {
        File tempFile = new File("test_fish_data.txt");
        try {
            boolean created = tempFile.createNewFile();
            assertTrue(tempFile.exists() || created, "File should exist or be created successfully");
        } catch (Exception e) {
            fail("Exception while creating test file: " + e.getMessage());
        } finally {
            tempFile.deleteOnExit();
        }
    }

    // ---- Add object to database (mock mode) ----
    @Test
    void testAddFish() {
        Fish fish = new Fish(
                "Bass",
                "Micropterus",
                12.0,
                "algae, crabs",
                List.of("River", "Lake"),
                "Least Concern",
                "001-01-0001"
        );
        boolean added = fishDAO.addFish(fish);
        assertTrue(added, "addFish() should return true when successful");

        List<Fish> fishList = fishDAO.getAllFish();
        assertEquals(1, fishList.size(), "Fish list should contain one fish");
        assertEquals("Bass", fishList.get(0).getCommonName());
    }

    // ---- Remove object from database ----
    @Test
    void testRemoveFish() {
        Fish fish = new Fish(
                "Snook",
                "Centropomus undecimalis",
                14.5,
                "shrimp, small fish",
                List.of("Mangrove", "Estuary"),
                "Near Threatened",
                "002-02-0002"
        );

        fishDAO.addFish(fish);
        boolean removed = fishDAO.removeFishByTag("002-02-0002");
        assertTrue(removed, "removeFishByTag() should return true if deletion succeeds");

        Fish result = fishDAO.findFishByTag("002-02-0002");
        assertNull(result, "Fish should be removed successfully");
    }

    // ---- Update object in the database ----
    @Test
    void testUpdateFish() {
        Fish original = new Fish(
                "Tarpon",
                "Megalops atlanticus",
                20.0,
                "crustaceans, small fish",
                List.of("Reef", "Mangrove"),
                "Least Concern",
                "003-03-0003"
        );

        fishDAO.addFish(original);

        // Modify average size and diet
        original.setAverageSize(22.5);
        original.setDiet("shrimp, anchovies");

        // IMPORTANT: pass the old tag as second argument
        boolean updated = fishDAO.updateFish(original, "003-03-0003");
        assertTrue(updated, "updateFish() should return true for successful updates");

        Fish updatedFish = fishDAO.findFishByTag("003-03-0003");
        assertNotNull(updatedFish);
        assertEquals(22.5, updatedFish.getAverageSize());
        assertEquals("shrimp, anchovies", updatedFish.getDiet());
    }

    // ---- Custom feature: calculate average fish size ----
    @Test
    void testCalculateAverageFishSize() {
        fishDAO.addFish(new Fish(
                "Redfish",
                "Sciaenops ocellatus",
                18.0,
                "crustaceans",
                List.of("Estuary", "Reef", "River"),
                "Least Concern",
                "004-04-0004"
        ));

        fishDAO.addFish(new Fish(
                "Bluegill",
                "Lepomis macrochirus",
                8.0,
                "insects, larvae",
                List.of("Lake", "River"),
                "Least Concern",
                "005-05-0005"
        ));

        double avgSize = fishDAO.calculateAverageFishSize();
        assertEquals(13.0, avgSize, 0.1, "Average fish size should be correctly calculated");
    }

    // ---- Integration test: calculate average habitats per fish via manager ----
    @Test
    void testCalculateAverageHabitatsViaManager() {
        FishManager manager = new FishManager(fishDAO);

        fishDAO.addFish(new Fish(
                "Redfish",
                "Sciaenops ocellatus",
                18.0,
                "crustaceans",
                List.of("Estuary", "Reef", "River"),
                "Least Concern",
                "004-04-0004"
        ));

        fishDAO.addFish(new Fish(
                "Bluegill",
                "Lepomis macrochirus",
                8.0,
                "insects, larvae",
                List.of("Lake", "River"),
                "Least Concern",
                "005-05-0005"
        ));

        // Now works because FishManager.getFishList() reads from DAO
        double avg = manager.calculateAverageHabitatsPerFish();
        assertEquals(2.5, avg, 0.1, "Average habitats per fish should be correctly calculated");
    }

    // ---- Negative scenario: file not found handling ----
    @Test
    void testFileNotFoundHandledGracefully() {
        File file = new File("nonexistent_file.txt");
        assertFalse(file.exists(), "File should not exist");

        assertDoesNotThrow(() -> {
            if (!file.exists()) {
                System.out.println("File not found. Handled safely.");
            }
        }, "Program should handle missing file without crashing");
    }

    // ---- Duplicate tag scenario should not crash ----
    @Test
    void testDuplicateTagWarningDoesNotCrash() {
        Fish fish1 = new Fish("Bass", "Micropterus", 12.0, "worms",
                List.of("Lake"), "Least Concern", "111-11-1111");
        Fish fish2 = new Fish("Another Bass", "Micropterus", 15.0, "insects",
                List.of("River"), "Least Concern", "111-11-1111");

        boolean add1 = fishDAO.addFish(fish1);
        boolean add2 = fishDAO.addFish(fish2);

        assertTrue(add1 && add2, "Both fish should be added successfully even if duplicate tags exist");
        assertEquals(2, fishDAO.getAllFish().size(),
                "Duplicate tags are allowed in mock mode and should be handled safely");
    }

    // ---- Custom action edge case: empty list ----
    @Test
    void testAverageHabitatsEmptyList() {
        FishManager manager = new FishManager(fishDAO);
        double avg = manager.calculateAverageHabitatsPerFish();
        assertEquals(0.0, avg, "Average should be 0.0 when no fish exist");
    }

    // ---- Verify clearAll() works as expected ----
    @Test
    void testClearAllFish() {
        fishDAO.addFish(new Fish(
                "Bluegill", "Lepomis", 8.0, "insects",
                List.of("Lake"), "Least Concern", "009-09-0009"));

        fishDAO.addFish(new Fish(
                "Catfish", "Ictalurus", 15.0, "algae",
                List.of("River"), "Least Concern", "010-10-0010"));

        assertEquals(2, fishDAO.getAllFish().size(), "Should have 2 fish before clearing");

        boolean cleared = fishDAO.clearAll();
        assertTrue(cleared, "clearAll() should return true");
        assertTrue(fishDAO.getAllFish().isEmpty(), "All fish should be removed after clearAll()");
    }
}
